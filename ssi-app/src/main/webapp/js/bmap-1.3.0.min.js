(function(BrowserMap){var cookiePrefix="BMAP_",deviceGroupCookieName="device",deviceOverrideParameter="device",languageOverrideParameter="language",enableForwardingWhenCookiesDisabled=false,matchRun=false,languageOverride=null,matchedDeviceGroups={},probes={},probeCache={},deviceGroups={};BrowserMap.THE_ANSWER_TO_LIFE_THE_UNIVERSE_AND_EVERYTHING=42;BrowserMap.VERSION="1.3.0";var linkDataDevgroups="data-bmap-devgroups";BrowserMap.getProbingResults=function(){var probingResults={},probe;for(probe in probes){if(probes.hasOwnProperty(probe)){probingResults[probe]=BrowserMap.probe(probe);}}return probingResults;};BrowserMap.config=function(config){if(config.cookiePrefix!==null){cookiePrefix=config.cookiePrefix;}if(config.deviceGroupCookieName!==null){deviceGroupCookieName=config.deviceGroupCookieName;}if(config.deviceOverrideParameter!==null){deviceOverrideParameter=config.deviceOverrideParameter;}if(config.languageOverrideParameter!==null){languageOverrideParameter=config.languageOverrideParameter;}if(config.enableForwardingWhenCookiesDisabled!==null){enableForwardingWhenCookiesDisabled=config.enableForwardingWhenCookiesDisabled;}};BrowserMap.getAllAlternateSites=function(){var alternateSites=[],links,i,link,headElement,onIE7=false,linkHref,devgroups;onIE7=navigator.appVersion.indexOf("MSIE 7")!==-1;headElement=document.getElementsByTagName("head")[0];if(headElement){links=headElement.getElementsByTagName("link");for(i=0;i<links.length;i++){link=links[i];devgroups=link.getAttribute(linkDataDevgroups);if(link.rel=="alternate"&&devgroups&&devgroups!==""){if(onIE7){linkHref=BrowserMapUtil.Url.qualifyURL(link.href);}else{linkHref=link.href;}alternateSites.push({"id":link.id,"href":linkHref,"hreflang":link.hreflang,"devgroups":devgroups});}}}return alternateSites;};BrowserMap.getAlternateSite=function(deviceGroups,filter){var alternateSites=BrowserMap.getAllAlternateSites(),maxLinkScore=0,alternateSite=null,currentURL=window.location.href,currentURLParameters=BrowserMapUtil.Url.getURLParametersString(currentURL),i,j,linkScore,devices;if(currentURLParameters&&currentURLParameters!==""){currentURL=currentURL.substring(0,currentURL.indexOf(currentURLParameters));}for(i=0;i<alternateSites.length;i++){linkScore=0;devices=alternateSites[i].devgroups.split(",");for(j=0;j<devices.length;j++){if(deviceGroups.indexOf(devices[j].trim())!==-1){linkScore++;}}if(typeof filter=="function"&&linkScore>0){if(filter(alternateSites[i])){linkScore++;}}if(linkScore>maxLinkScore){alternateSite=alternateSites[i];maxLinkScore=linkScore;}}return alternateSite;};BrowserMap.getDeviceGroupsInRankingOrder=function(){var dgs=[],dg;for(dg in deviceGroups){if(deviceGroups.hasOwnProperty(dg)){dgs.push(deviceGroups[dg]);}}dgs.sort(function(a,b){return a.ranking-b.ranking;});return dgs;};BrowserMap.probe=function(probeName){if(!probes[probeName]){return null;}if(!probeCache.hasOwnProperty(probeName)){probeCache[probeName]=probes[probeName]();}return probeCache[probeName];};BrowserMap.getNewURL=function(currentURL,detectedDeviceGroups,urlSelectors){var newURL=null,alternateSite=BrowserMap.getAlternateSite(detectedDeviceGroups,function(alternateLink){if(languageOverride&&alternateLink.hreflang&&alternateLink.hreflang.lastIndexOf(languageOverride)===0){return true;}}),i,dg,parameters=BrowserMapUtil.Url.getURLParametersString(currentURL),urlNoParams=currentURL.replace(parameters,"");if(alternateSite){newURL=alternateSite.href;}if(!newURL){for(i=0;i<detectedDeviceGroups.length;i++){dg=BrowserMap.getDeviceGroupByName(detectedDeviceGroups[i]);if(dg){newURL=dg.url;if(newURL){break;}}}}if(!newURL){newURL=BrowserMapUtil.Url.addSelectorsToURL(urlNoParams,urlSelectors);}if(parameters){newURL+=parameters;}return newURL;};BrowserMap.removeOverride=function(){var oCookie=BrowserMapUtil.CookieManager.getCookie("o_"+cookiePrefix+deviceGroupCookieName),currentURL=window.location.href,parameters=BrowserMapUtil.Url.getURLParametersString(currentURL),overrideParameter,indexOfOverride;if(oCookie){BrowserMapUtil.CookieManager.removeCookie(cookiePrefix+deviceGroupCookieName);BrowserMapUtil.CookieManager.removeCookie(oCookie.name);oCookie.name=cookiePrefix+deviceGroupCookieName;oCookie.path="/";BrowserMapUtil.CookieManager.setCookie(oCookie);}if(parameters){overrideParameter=deviceOverrideParameter+"="+BrowserMapUtil.Url.getValueForParameter(currentURL,deviceOverrideParameter);currentURL=currentURL.replace(parameters,"");indexOfOverride=parameters.indexOf(overrideParameter);if(indexOfOverride!==-1){if(parameters.length>indexOfOverride+overrideParameter.length){if(parameters[indexOfOverride-1]=="?"){parameters=parameters.replace(overrideParameter+"&","");}else{parameters=parameters.replace("&"+overrideParameter,"");}}else{parameters=parameters.replace("?"+overrideParameter,"");}}currentURL+=parameters;}window.location=currentURL;};BrowserMap.forwardRequest=function(){var currentURL=window.location.href,deviceOverride=BrowserMapUtil.Url.getValueForParameter(currentURL,deviceOverrideParameter),detectedDeviceGroups=[],urlSelectors=[],oCookie=BrowserMapUtil.CookieManager.getCookie("o_"+cookiePrefix+deviceGroupCookieName),cookie=BrowserMapUtil.CookieManager.getCookie(cookiePrefix+deviceGroupCookieName),dgs=[],i,g,registeredDeviceGroups,dgName,domain,aTags,url,parameters,newURL,canonicalURL=BrowserMapUtil.Url.getCanonicalURL();if(BrowserMap.isEnabled()){languageOverride=BrowserMapUtil.Url.getValueForParameter(currentURL,languageOverrideParameter);if(deviceOverride){detectedDeviceGroups=deviceOverride.split(",");if(detectedDeviceGroups.length>0){if(BrowserMapUtil.CookieManager.cookiesEnabled()){if(!oCookie&&!cookie){oCookie=new Cookie();oCookie.name="o_"+cookiePrefix+deviceGroupCookieName;oCookie.path="/";BrowserMap.matchDeviceGroups();for(g in matchedDeviceGroups){if(matchedDeviceGroups.hasOwnProperty(g)){dgs.push(matchedDeviceGroups[g].name);}}if(deviceOverride!==dgs.join(",")){oCookie.value=dgs.join(",");BrowserMapUtil.CookieManager.setCookie(oCookie);}}else{if(!oCookie){if(cookie.value!==detectedDeviceGroups.join(",")){cookie.name="o_"+cookie.name;cookie.path="/";BrowserMapUtil.CookieManager.setCookie(cookie);}}}cookie=new Cookie();cookie.name=cookiePrefix+deviceGroupCookieName;cookie.value=detectedDeviceGroups.join(",");cookie.path="/";BrowserMapUtil.CookieManager.setCookie(cookie);if(oCookie){if(oCookie.value==cookie.value){BrowserMapUtil.CookieManager.removeCookie(oCookie.name);}}}}}if(cookie!==null||deviceOverride){registeredDeviceGroups=BrowserMap.getDeviceGroups();if(detectedDeviceGroups.length===0){detectedDeviceGroups=cookie.value.split(",");}matchedDeviceGroups={};for(i=0;i<detectedDeviceGroups.length;i++){dgName=detectedDeviceGroups[i].trim();if(registeredDeviceGroups.hasOwnProperty(dgName)){if(registeredDeviceGroups[dgName].isSelector){urlSelectors.push(dgName);}matchedDeviceGroups[dgName]=registeredDeviceGroups[dgName];}}if(deviceOverride&&cookie===null&&enableForwardingWhenCookiesDisabled){domain=BrowserMapUtil.Url.getDomainFromURL(window.location.href);aTags=document.getElementsByTagName("a");for(i=0;i<aTags.length;i++){url=aTags[i].href;if(url&&url.indexOf(domain)!==-1){parameters=BrowserMapUtil.Url.getURLParametersString(url);if(parameters){if(parameters.indexOf(languageOverrideParameter+"="+deviceOverride)==-1){aTags[i].href=url+"&"+deviceOverrideParameter+"="+deviceOverride;}}else{aTags[i].href=url+"?"+deviceOverrideParameter+"="+deviceOverride;}}}}}else{BrowserMap.matchDeviceGroups();for(g in matchedDeviceGroups){if(matchedDeviceGroups.hasOwnProperty(g)){if(matchedDeviceGroups[g].isSelector){urlSelectors.push(matchedDeviceGroups[g].name);}detectedDeviceGroups.push(matchedDeviceGroups[g].name);}}cookie=new Cookie();cookie.name=cookiePrefix+deviceGroupCookieName;cookie.value=detectedDeviceGroups.join(",");cookie.path="/";BrowserMapUtil.CookieManager.setCookie(cookie);}newURL=BrowserMap.getNewURL(currentURL,detectedDeviceGroups,urlSelectors);if(currentURL!==newURL&&canonicalURL!==newURL){window.location=newURL;}}};BrowserMap.clearProbeCache=function(){probeCache={};};BrowserMap.addDeviceGroup=function(deviceGroup){if(typeof deviceGroup.ranking!=="number"){throw new TypeError("Expected a Number for device group "+deviceGroup.name+" ranking");}if(typeof deviceGroup.testFunction!=="function"){throw new TypeError("Expected a Function for device group "+deviceGroup.name+" testFunction");}deviceGroups[deviceGroup.name]=deviceGroup;};BrowserMap.addProbe=function(name,probe){if(typeof name!=="string"||name.length<1){throw new TypeError("invalid probe name");}if(typeof probe!=="function"){throw new TypeError("invalid probe function");}if(!probes.hasOwnProperty(name)){probes[name]=probe;}return BrowserMap;};BrowserMap.getMatchedDeviceGroups=function(){return matchedDeviceGroups;};BrowserMap.getDeviceGroups=function(){return deviceGroups;};BrowserMap.matchDeviceGroups=function(){var deviceGroupsArray=BrowserMap.getDeviceGroupsInRankingOrder(),i,deviceGroup;for(i=0;i<deviceGroupsArray.length;i++){deviceGroup=deviceGroupsArray[i];if(!!deviceGroup.testFunction.call()){matchedDeviceGroups[deviceGroup.name]=deviceGroup;}}matchRun=true;};BrowserMap.getDeviceGroupByName=function(groupName){return deviceGroups[groupName];};BrowserMap.isEnabled=function(){var headElement=document.getElementsByTagName("head")[0],metaTags,i,name,tag;if(headElement){metaTags=headElement.getElementsByTagName("meta");for(i=0;i<metaTags.length;i++){if((tag=metaTags[i])&&(name=tag.getAttribute("name"))){if(name==="browsermap.enabled"&&tag.getAttribute("content")==="false"){return false;}}}}return true;};return BrowserMap;})(window.BrowserMap=window.BrowserMap||{});